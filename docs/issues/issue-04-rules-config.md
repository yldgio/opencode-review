# Issue 4 - Project Rules/Config for Stack Context

**Status:** DONE

## Overview

Create the configuration files that store detected stack information and ensure OpenCode loads them automatically.

---

## Subtasks

### 4.1 Create `.opencode/rules/stack-context.md` Template

**Status:** DONE

**Requirement:**
Provide a template file that the setup agent writes after detecting the project stack. The coordinator reads this file to know which skills to load.

**Implementation Details:**

1. Create directory `.opencode/rules/` if it doesn't exist

2. Create template file `.opencode/rules/stack-context.md`:

```markdown
# Stack Context

This file is generated by the `review-setup` agent. Do not edit manually unless you need to override detection.

## Detected Stacks

<!-- List of technology stacks detected in this project -->
- [stack-name]

## Skills to Load

<!-- Skills that should be loaded for code review -->
- [skill-name]

## Detection Timestamp

<!-- When this detection was run -->
Generated: [ISO timestamp]

## Notes

<!-- Any additional context about the project -->
[Optional notes about the project structure or special considerations]
```

3. Example filled template:

```markdown
# Stack Context

This file is generated by the `review-setup` agent. Do not edit manually unless you need to override detection.

## Detected Stacks

- Next.js (App Router)
- React
- TypeScript
- Docker
- GitHub Actions

## Skills to Load

- nextjs
- react
- docker
- github-actions

## Detection Timestamp

Generated: 2025-01-29T10:00:00Z

## Notes

- Uses pnpm for package management
- Monorepo structure with apps/ and packages/ directories
```

4. Format requirements:
   - Skills listed under "## Skills to Load" as bullet points
   - One skill per line, format: `- skill-name`
   - Coordinator parses this section to determine which skills to load

**Acceptance Criteria:**
- [x] Template file exists at `templates/stack-context.md`
- [x] Format is parseable (bullet list under specific heading)
- [x] Template includes placeholder sections for stacks, skills, timestamp
- [x] Comments explain the purpose and that it's auto-generated

**Note:** Template is stored in `templates/` directory. The installer (Issue 5) will copy it to `.opencode/rules/stack-context.md` in the target project.

---

### 4.2 Add `opencode.json` Configuration

**Status:** DONE

**Requirement:**
Ensure OpenCode loads the stack context rules automatically when starting a session.

**Implementation Details:**

1. Create `.opencode/opencode.json`:

```json
{
  "$schema": "https://opencode.ai/config.json",
  "instructions": [
    ".opencode/rules/stack-context.md"
  ],
  "permission": {
    "skill": {
      "*": "allow"
    }
  }
}
```

2. Configuration explanation:
   - `instructions`: Loads the stack context file into agent context
   - `permission.skill.*`: Allows agents to load any skill without prompting

3. Optional additions for future:
```json
{
  "$schema": "https://opencode.ai/config.json",
  "instructions": [
    ".opencode/rules/stack-context.md",
    ".opencode/rules/*.md"
  ],
  "permission": {
    "skill": {
      "*": "allow"
    },
    "task": {
      "review-*": "allow"
    }
  }
}
```

**Acceptance Criteria:**
- [x] File exists at `templates/opencode.json`
- [x] Valid JSON with `$schema` reference
- [x] `instructions` array includes stack context file path
- [x] Skill permissions configured to allow loading

**Note:** Template is stored in `templates/` directory. The installer (Issue 5) will copy it to `.opencode/opencode.json` in the target project.

---

## Files to Create

| File | Action |
|------|--------|
| `templates/stack-context.md` | CREATE (template for target projects) |
| `templates/opencode.json` | CREATE (config template for target projects) |

---

## Dependencies

- Issue 1: Setup agent writes to `stack-context.md`
- Issue 3: Coordinator reads from `stack-context.md`

---

## Testing

1. Verify `opencode.json` is valid JSON (use `jq` or JSON validator)
2. Start OpenCode in the project directory
3. Verify the stack context file is mentioned in loaded instructions
4. Test that skills can be loaded without permission prompts
